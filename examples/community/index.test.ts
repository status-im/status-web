/**
 * E2E test suite
 */

/**
 * Examples:
 * - search for keywords (ie. e2e, end-to-end, broswer, .goto, localhost) in repositories of imported packages in this file
 * - https://github.com/vitest-dev/vitest/blob/main/examples/puppeteer/test/basic.test.ts (preview, puppeteer)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/lit/test/basic.test.ts (happy-dom)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/nextjs/__tests__/Home.test.tsx (render)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/react-mui/test/testUtils.tsx (render)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/react-storybook/src/App.test.tsx (render, screen)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/react-enzyme/test/Button.test.tsx (shallow render)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/solid/test/Hello.test.jsx#L9 (fireEvent, render)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/react/test/basic.test.tsx (renderer)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/ruby/test/components/Test.spec.ts (mount)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/vue-jsx/test/case.test.ts#L15 (shallowMount)
 * - https://github.com/vitest-dev/vitest/blob/main/examples/vue/test/async.test.ts#L17 (nextTick, flushPromises)
 */

// TODO!: mock js-waku
// TODO: remove headless config
// TODO: remove page.pause()
// TODO: remove timeouts
// TODO?: remove comments
// TODO?: other browsers
// FIXME: run from editor, not just cli
// TODO?: nest in describe
// TODO?!: test unmount (to gracefully disconnect from waku)
// TODO?: mount match snapshot

import { chromium /*, firefox, webkit */ } from 'playwright'
import { build, preview } from 'vite'
import {
  afterAll,
  afterEach,
  beforeAll,
  beforeEach,
  expect,
  test,
  // vi,
} from 'vitest'

// import { App } from './src/app'
import type { Browser, BrowserContext, Page } from 'playwright'
import type { PreviewServer } from 'vite'

const date = new Date()

const obj = {
  foo: () => console.log(date.getTime(), date),
}

// vi.mock('@status-im/react', () => {
//   return {}
// })

// vi.mock('js-waku', () => {
//   // const Waku = () => console.log('mock')
//   const Waku = vi.fn()

//   // Client.prototype.connect = vi.fn()

//   return { Waku }
// })

let server: PreviewServer
let browser: Browser
let context: BrowserContext
let page: Page

beforeAll(async () => {
  await build({
    // todo:? use
    configFile: './vite.config.ts',
  })
  server = await preview({
    preview: { port: 3001 },
    // test: {
    //   deps: {
    //     inline: ['js-waku'],
    //   },
    // },
  })
  // execa("npm run build")
  // browser = await chromium.launch()
  browser = await chromium.launch({ headless: false, devtools: true })
})

afterAll(async () => {
  await context.close()
  await browser.close()
  await server.httpServer.close()
})

// todo?: create a new context
// https://playwright.dev/docs/browser-contexts
beforeEach(async () => {
  // const contextA = await browser.newContext()

  // contextA.addInitScript(
  //   //   {
  //   //   path: './waku-mock.ts',
  //   // }
  //   obj => {
  //     console.log('HERE')
  //     console.log(obj)
  //     window.waku = obj
  //   },
  //   { create: () => console.log(date.getTime(), date) }
  // )

  // pageA = await contextA.newPage()

  // const contextB = await browser.newContext()

  // contextB.addInitScript({
  //   path: './waku-mock.ts',
  // })

  // pageB = await contextA.newPage()

  // pageB = await contextA.newPage()

  // const mock = {
  //   // todo: returns .waitForRemotePeer
  //   create: vi.fn(),
  //   libp2p: {
  //     connectionManager: {
  //       // empty so wakuDisconnectionTimer runs without effect
  //       connections: new Map(),
  //     },
  //   },
  //   stop: undefined,
  //   store: {
  //     queryHistory: undefined,
  //     addDecryptionKey: undefined,
  //   },
  //   relay: {
  //     addObserver: undefined,
  //     addDecryptionKey: undefined,
  //     deleteObserver: undefined,
  //     send: undefined,
  //   },
  // }

  context = await browser.newContext({
    recordHar: { path: 'example.har' },
  })
  // await context.exposeFunction('getObj', () => obj)
  await context.addInitScript({ path: './js-waku-mock-script.js' })
  page = await context.newPage()
  await page.addInitScript(() => {
    globalThis.waku.foo()
    globalThis.waku.historyMessages.set('/waku/1/0x35cd47c5/rfc26', [
      {
        payload: new Uint8Array([
          10, 65, 213, 2, 20, 140, 25, 74, 173, 202, 112, 154, 218, 234, 227,
          44, 33, 183, 87, 170, 221, 99, 178, 56, 146, 39, 58, 103, 38, 100, 72,
          231, 213, 218, 77, 124, 149, 196, 46, 89, 97, 143, 169, 40, 175, 214,
          200, 125, 31, 188, 86, 167, 197, 13, 20, 229, 78, 114, 222, 148, 245,
          185, 84, 124, 89, 97, 1, 18, 209, 41, 8, 102, 18, 137, 1, 10, 132, 1,
          48, 120, 48, 52, 53, 101, 100, 54, 102, 52, 55, 99, 48, 100, 99, 50,
          54, 97, 49, 51, 57, 101, 54, 49, 99, 56, 102, 54, 57, 48, 102, 51, 55,
          51, 51, 97, 98, 102, 48, 97, 57, 102, 55, 57, 56, 57, 101, 57, 51, 55,
          53, 54, 52, 98, 50, 100, 99, 99, 48, 51, 100, 48, 97, 56, 97, 57, 54,
          99, 57, 50, 48, 48, 49, 102, 55, 55, 55, 49, 56, 54, 101, 57, 98, 97,
          48, 50, 98, 57, 102, 50, 50, 56, 97, 99, 100, 53, 98, 57, 51, 51, 57,
          101, 101, 56, 54, 53, 55, 52, 102, 53, 56, 56, 100, 51, 56, 51, 52,
          99, 49, 53, 99, 52, 53, 97, 50, 50, 100, 53, 53, 53, 101, 55, 18, 0,
          18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 100, 56, 97, 48, 101, 51, 53,
          53, 52, 54, 98, 98, 52, 56, 50, 51, 97, 51, 55, 49, 49, 48, 49, 54,
          52, 55, 102, 48, 50, 99, 50, 97, 52, 55, 53, 97, 55, 55, 98, 97, 50,
          50, 48, 56, 54, 98, 51, 57, 99, 99, 100, 97, 101, 48, 97, 98, 57, 97,
          102, 98, 50, 53, 51, 49, 97, 56, 53, 98, 101, 97, 53, 98, 54, 53, 102,
          54, 48, 97, 97, 57, 53, 52, 50, 55, 53, 51, 53, 98, 53, 98, 97, 54,
          51, 51, 56, 99, 100, 54, 48, 101, 53, 55, 50, 101, 53, 52, 48, 48,
          101, 99, 52, 52, 57, 51, 100, 98, 100, 102, 49, 56, 54, 51, 98, 97,
          53, 97, 102, 99, 18, 0, 18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 98,
          99, 57, 55, 57, 48, 57, 50, 50, 101, 56, 55, 101, 48, 54, 51, 54, 57,
          49, 55, 99, 49, 56, 100, 52, 49, 49, 102, 55, 98, 98, 53, 99, 55, 54,
          51, 50, 99, 54, 56, 102, 54, 101, 57, 57, 97, 54, 48, 55, 52, 52, 56,
          48, 102, 98, 52, 101, 53, 101, 48, 52, 99, 51, 101, 54, 49, 99, 100,
          55, 55, 100, 48, 55, 52, 50, 50, 48, 101, 48, 56, 101, 55, 101, 57,
          51, 57, 57, 56, 56, 98, 54, 54, 52, 100, 99, 52, 101, 99, 97, 101, 55,
          54, 50, 54, 101, 48, 102, 56, 55, 52, 97, 53, 98, 49, 97, 50, 97, 52,
          55, 49, 56, 54, 53, 102, 52, 101, 54, 97, 18, 0, 18, 137, 1, 10, 132,
          1, 48, 120, 48, 52, 48, 51, 97, 101, 102, 102, 50, 102, 100, 100, 48,
          48, 52, 52, 98, 49, 51, 54, 101, 48, 54, 97, 102, 97, 54, 100, 54, 57,
          98, 98, 53, 54, 51, 98, 98, 55, 98, 51, 102, 100, 53, 49, 56, 98, 98,
          51, 48, 99, 48, 100, 53, 49, 49, 53, 97, 50, 101, 48, 50, 48, 56, 52,
          48, 97, 50, 50, 52, 55, 57, 54, 54, 99, 50, 99, 99, 57, 57, 53, 51,
          101, 100, 48, 50, 99, 99, 51, 57, 49, 101, 56, 56, 56, 51, 98, 51, 51,
          49, 57, 102, 54, 51, 97, 51, 49, 101, 53, 102, 53, 51, 54, 57, 100,
          48, 102, 98, 55, 50, 98, 54, 50, 98, 50, 51, 100, 102, 99, 98, 100,
          18, 0, 18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 100, 97, 98, 48, 56,
          53, 51, 53, 52, 100, 51, 100, 57, 97, 53, 102, 52, 102, 97, 100, 101,
          51, 48, 50, 51, 48, 54, 97, 102, 52, 54, 51, 54, 48, 102, 102, 54, 54,
          98, 101, 99, 97, 51, 53, 49, 51, 99, 57, 49, 56, 52, 97, 102, 51, 49,
          53, 56, 48, 48, 99, 53, 53, 57, 97, 54, 57, 50, 52, 51, 98, 49, 55,
          53, 48, 49, 48, 53, 98, 99, 53, 53, 97, 98, 98, 101, 48, 101, 57, 54,
          102, 50, 50, 52, 56, 53, 50, 101, 102, 102, 54, 50, 57, 52, 55, 55,
          100, 98, 53, 53, 100, 52, 57, 100, 52, 98, 56, 57, 56, 48, 53, 51, 57,
          97, 97, 48, 54, 57, 56, 18, 0, 18, 137, 1, 10, 132, 1, 48, 120, 48,
          52, 101, 102, 53, 52, 54, 57, 57, 55, 102, 97, 97, 54, 48, 54, 97, 51,
          52, 97, 99, 55, 101, 49, 100, 54, 52, 51, 98, 53, 48, 53, 102, 55, 57,
          51, 52, 52, 99, 52, 55, 97, 53, 53, 49, 50, 99, 54, 55, 101, 48, 55,
          101, 48, 53, 98, 50, 49, 57, 55, 99, 52, 101, 99, 100, 52, 100, 57,
          100, 48, 97, 97, 57, 54, 50, 100, 97, 50, 100, 102, 52, 102, 102, 98,
          49, 97, 57, 53, 98, 52, 55, 52, 54, 97, 49, 56, 49, 57, 49, 54, 55,
          102, 97, 53, 53, 48, 55, 99, 56, 50, 98, 56, 57, 49, 55, 50, 97, 56,
          102, 56, 51, 49, 51, 57, 48, 52, 56, 99, 51, 53, 18, 0, 18, 137, 1,
          10, 132, 1, 48, 120, 48, 52, 57, 52, 99, 53, 54, 56, 48, 52, 56, 57,
          100, 102, 53, 52, 53, 56, 99, 51, 100, 57, 102, 54, 98, 53, 52, 99,
          54, 57, 50, 50, 101, 56, 102, 97, 101, 102, 97, 57, 50, 56, 53, 51,
          56, 56, 97, 97, 48, 49, 55, 99, 55, 57, 51, 55, 98, 53, 57, 54, 50,
          98, 55, 48, 55, 57, 48, 101, 56, 101, 52, 99, 49, 55, 50, 101, 98, 57,
          50, 51, 54, 54, 56, 98, 49, 51, 55, 99, 51, 48, 102, 100, 55, 49, 98,
          52, 54, 57, 55, 55, 51, 48, 52, 101, 100, 57, 51, 56, 97, 55, 57, 100,
          97, 98, 54, 50, 48, 101, 56, 55, 102, 97, 50, 48, 98, 100, 98, 54, 54,
          101, 18, 0, 18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 56, 48, 55, 49,
          55, 48, 101, 57, 56, 97, 98, 54, 49, 49, 53, 53, 97, 99, 97, 100, 49,
          48, 97, 97, 99, 102, 50, 50, 102, 99, 49, 48, 102, 54, 98, 53, 51, 56,
          97, 50, 100, 56, 48, 97, 97, 100, 52, 51, 98, 97, 54, 54, 101, 57, 54,
          54, 56, 48, 51, 102, 52, 100, 52, 55, 56, 101, 97, 52, 55, 49, 54, 51,
          51, 101, 55, 52, 57, 98, 54, 51, 48, 99, 99, 50, 57, 51, 97, 97, 100,
          101, 51, 101, 56, 99, 48, 97, 53, 57, 101, 53, 50, 57, 97, 55, 48, 97,
          99, 98, 54, 57, 52, 49, 101, 50, 52, 101, 102, 100, 57, 102, 99, 56,
          100, 51, 52, 51, 101, 52, 18, 0, 18, 140, 1, 10, 132, 1, 48, 120, 48,
          52, 97, 99, 52, 49, 57, 100, 97, 99, 57, 97, 56, 98, 98, 98, 53, 56,
          56, 50, 53, 97, 51, 99, 100, 101, 54, 48, 101, 101, 102, 48, 101, 101,
          55, 49, 98, 56, 99, 102, 54, 99, 54, 51, 100, 102, 54, 49, 49, 101,
          101, 101, 102, 99, 56, 101, 55, 97, 97, 99, 55, 99, 55, 57, 98, 53,
          53, 57, 53, 52, 98, 54, 55, 57, 100, 50, 52, 99, 102, 53, 101, 99, 56,
          50, 100, 97, 55, 101, 100, 57, 50, 49, 99, 97, 102, 50, 52, 48, 54,
          50, 56, 97, 57, 98, 102, 98, 51, 52, 53, 48, 99, 53, 49, 49, 49, 97,
          57, 99, 102, 102, 101, 53, 52, 101, 54, 51, 49, 56, 49, 49, 18, 3, 10,
          1, 1, 18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 101, 56, 102, 56, 101,
          50, 56, 49, 53, 51, 99, 100, 98, 49, 97, 52, 56, 98, 56, 56, 100, 100,
          49, 97, 53, 100, 51, 100, 55, 99, 100, 48, 49, 53, 48, 97, 101, 57,
          49, 48, 99, 100, 57, 51, 55, 102, 57, 101, 57, 49, 55, 48, 98, 100,
          57, 50, 55, 51, 101, 51, 49, 50, 51, 99, 100, 53, 55, 102, 98, 102,
          54, 48, 99, 49, 55, 54, 97, 57, 50, 57, 101, 100, 101, 55, 99, 55, 52,
          54, 102, 55, 99, 99, 97, 100, 101, 48, 102, 55, 52, 98, 51, 98, 101,
          48, 99, 102, 49, 52, 48, 52, 55, 56, 50, 54, 98, 57, 57, 102, 51, 49,
          99, 51, 54, 102, 102, 49, 101, 56, 18, 0, 18, 137, 1, 10, 132, 1, 48,
          120, 48, 52, 57, 55, 55, 101, 51, 52, 100, 97, 100, 102, 49, 53, 50,
          57, 55, 52, 100, 53, 100, 53, 98, 52, 53, 99, 101, 100, 100, 51, 54,
          56, 57, 50, 55, 52, 49, 100, 49, 51, 52, 57, 97, 99, 99, 101, 52, 50,
          99, 52, 98, 101, 50, 52, 55, 102, 98, 52, 50, 52, 99, 53, 99, 102, 56,
          48, 52, 101, 102, 55, 57, 49, 57, 57, 50, 55, 53, 102, 101, 97, 98,
          99, 56, 100, 50, 99, 49, 99, 53, 56, 99, 101, 56, 49, 102, 52, 55, 97,
          51, 48, 97, 102, 97, 49, 57, 100, 98, 54, 50, 102, 51, 97, 52, 51, 52,
          57, 102, 99, 52, 98, 98, 49, 50, 101, 56, 51, 55, 48, 101, 48, 18, 0,
          18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 53, 98, 53, 50, 55, 98, 99,
          56, 56, 98, 50, 51, 98, 50, 54, 52, 102, 98, 48, 55, 101, 98, 53, 51,
          54, 50, 50, 48, 52, 52, 97, 97, 57, 54, 98, 101, 100, 52, 50, 97, 98,
          57, 50, 56, 56, 102, 55, 52, 55, 99, 51, 52, 55, 98, 100, 100, 49, 53,
          54, 53, 49, 102, 56, 57, 50, 98, 51, 52, 55, 54, 101, 98, 51, 101, 97,
          52, 101, 48, 54, 55, 49, 51, 54, 56, 56, 48, 100, 101, 56, 57, 98, 56,
          100, 48, 54, 52, 51, 102, 54, 98, 53, 53, 52, 56, 101, 102, 49, 50,
          97, 52, 102, 48, 56, 98, 99, 52, 54, 100, 100, 48, 102, 53, 53, 102,
          101, 52, 57, 49, 18, 0, 18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 52,
          56, 102, 53, 55, 99, 99, 98, 48, 51, 48, 102, 48, 50, 53, 97, 57, 100,
          53, 57, 98, 49, 98, 49, 54, 101, 51, 101, 50, 49, 54, 100, 99, 52, 48,
          50, 54, 57, 48, 56, 99, 99, 54, 54, 49, 52, 102, 99, 53, 102, 98, 97,
          102, 56, 99, 49, 99, 99, 48, 98, 49, 52, 99, 100, 100, 51, 52, 51, 53,
          102, 97, 54, 57, 57, 56, 100, 101, 101, 102, 55, 101, 52, 56, 56, 100,
          97, 52, 56, 51, 54, 100, 50, 54, 55, 99, 100, 54, 102, 49, 99, 49,
          100, 99, 53, 54, 52, 49, 49, 57, 57, 100, 101, 54, 51, 98, 97, 53, 55,
          100, 101, 56, 51, 52, 98, 54, 50, 98, 98, 18, 0, 18, 137, 1, 10, 132,
          1, 48, 120, 48, 52, 100, 54, 52, 55, 48, 99, 100, 101, 56, 51, 100,
          51, 53, 98, 49, 101, 54, 54, 102, 52, 49, 54, 54, 57, 101, 99, 49, 57,
          50, 50, 51, 98, 56, 97, 49, 50, 55, 53, 51, 54, 48, 102, 101, 57, 54,
          52, 54, 51, 101, 101, 102, 54, 49, 53, 49, 52, 54, 49, 48, 55, 55, 99,
          49, 50, 101, 51, 48, 51, 53, 100, 53, 98, 55, 54, 50, 55, 97, 99, 52,
          56, 57, 48, 53, 49, 101, 52, 53, 100, 97, 48, 99, 53, 57, 101, 100,
          100, 99, 54, 50, 56, 54, 100, 97, 97, 49, 53, 98, 52, 98, 56, 50, 54,
          54, 55, 49, 48, 102, 55, 51, 53, 99, 51, 101, 101, 55, 98, 100, 56,
          18, 0, 18, 137, 1, 10, 132, 1, 48, 120, 48, 52, 55, 48, 49, 52, 101,
          101, 53, 98, 98, 100, 97, 50, 49, 49, 57, 99, 56, 57, 54, 48, 51, 101,
          50, 102, 98, 48, 53, 102, 56, 57, 50, 54, 57, 55, 48, 99, 56, 57, 52,
          56, 50, 100, 50, 52, 97, 54, 100, 57, 57, 97, 97, 56, 49, 99, 56, 54,
          49, 56, 55, 54, 101, 101, 97, 102, 99, 57, 56, 98, 52, 102, 97, 100,
          56, 48, 52, 101, 50, 100, 98, 101, 98, 99, 54, 53, 48, 52, 50, 97, 56,
          53, 97, 56, 49, 57, 102, 98, 48, 54, 54, 99, 48, 97, 50, 55, 97, 53,
          98, 102, 102, 99, 48, 52, 98, 48, 102, 100, 48, 98, 50, 50, 54, 101,
          57, 54, 56, 57, 49, 50, 18, 0, 26, 2, 24, 3, 42, 51, 34, 16, 66, 111,
          114, 105, 110, 103, 32, 99, 111, 109, 109, 117, 110, 105, 116, 121,
          42, 22, 68, 101, 115, 99, 114, 105, 112, 116, 105, 111, 110, 32, 117,
          112, 100, 97, 116, 101, 100, 46, 46, 46, 50, 7, 35, 52, 51, 54, 48,
          68, 70, 50, 62, 10, 36, 56, 52, 57, 53, 48, 98, 53, 50, 45, 51, 97,
          52, 52, 45, 52, 98, 102, 102, 45, 97, 52, 56, 99, 45, 52, 98, 100,
          102, 99, 48, 57, 55, 51, 49, 102, 57, 18, 22, 18, 2, 24, 1, 26, 14,
          34, 6, 114, 97, 110, 100, 111, 109, 42, 4, 100, 101, 115, 99, 40, 4,
          50, 94, 10, 36, 99, 50, 101, 97, 100, 48, 101, 48, 45, 97, 50, 98, 54,
          45, 52, 102, 102, 57, 45, 57, 55, 57, 55, 45, 54, 49, 100, 54, 50,
          100, 101, 99, 52, 101, 55, 98, 18, 54, 18, 2, 24, 1, 26, 48, 34, 21,
          116, 101, 115, 116, 45, 99, 114, 101, 97, 116, 101, 45, 116, 101, 115,
          116, 45, 116, 101, 115, 116, 42, 14, 112, 105, 110, 107, 32, 99, 111,
          109, 109, 117, 110, 105, 116, 121, 50, 7, 35, 68, 70, 52, 51, 65, 54,
          50, 93, 10, 36, 49, 100, 53, 101, 101, 48, 102, 53, 45, 55, 98, 97,
          99, 45, 52, 52, 57, 53, 45, 98, 55, 54, 101, 45, 52, 101, 99, 98, 100,
          53, 55, 55, 53, 51, 102, 48, 18, 53, 18, 2, 24, 1, 26, 45, 34, 16,
          116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101,
          108, 42, 16, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97,
          110, 110, 101, 108, 50, 7, 35, 52, 51, 54, 48, 68, 70, 40, 9, 50, 85,
          10, 36, 49, 98, 101, 98, 52, 48, 48, 48, 45, 101, 56, 50, 48, 45, 52,
          99, 51, 102, 45, 56, 51, 57, 50, 45, 49, 102, 101, 97, 51, 98, 102,
          101, 97, 100, 51, 100, 18, 45, 18, 2, 24, 1, 26, 37, 34, 12, 116, 101,
          115, 116, 45, 114, 101, 112, 108, 105, 101, 115, 42, 12, 116, 101,
          115, 116, 45, 114, 101, 112, 108, 105, 101, 115, 50, 7, 35, 52, 51,
          54, 48, 68, 70, 40, 11, 50, 137, 1, 10, 36, 98, 57, 56, 55, 98, 57,
          101, 57, 45, 48, 55, 102, 50, 45, 52, 49, 97, 55, 45, 56, 55, 53, 50,
          45, 97, 56, 48, 55, 100, 97, 54, 51, 52, 50, 52, 100, 18, 97, 18, 2,
          24, 1, 26, 51, 34, 19, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99,
          104, 97, 110, 110, 101, 108, 45, 49, 57, 42, 19, 116, 101, 115, 116,
          45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 49, 57,
          50, 7, 35, 52, 51, 54, 48, 68, 70, 34, 36, 56, 102, 50, 99, 99, 53,
          100, 55, 45, 101, 99, 98, 54, 45, 52, 50, 99, 100, 45, 97, 102, 49,
          55, 45, 49, 101, 55, 101, 100, 57, 57, 51, 98, 100, 55, 97, 40, 4, 50,
          97, 10, 36, 100, 101, 48, 54, 48, 50, 101, 100, 45, 48, 98, 56, 97,
          45, 52, 100, 54, 48, 45, 98, 97, 53, 50, 45, 49, 52, 54, 56, 101, 57,
          49, 100, 50, 102, 101, 50, 18, 57, 18, 2, 24, 1, 26, 49, 34, 18, 116,
          101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108,
          45, 49, 42, 18, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104,
          97, 110, 110, 101, 108, 45, 49, 50, 7, 35, 52, 51, 54, 48, 68, 70, 40,
          8, 50, 89, 10, 36, 97, 57, 100, 101, 101, 50, 52, 54, 45, 55, 52, 99,
          100, 45, 52, 48, 99, 52, 45, 97, 102, 53, 54, 45, 101, 50, 56, 54, 54,
          97, 52, 52, 54, 99, 51, 102, 18, 49, 18, 2, 24, 1, 26, 41, 34, 15,
          116, 101, 115, 116, 45, 111, 110, 101, 45, 111, 110, 45, 111, 110,
          101, 42, 13, 100, 101, 119, 108, 107, 106, 100, 102, 115, 108, 107,
          97, 100, 50, 7, 35, 68, 70, 52, 51, 52, 53, 40, 10, 50, 104, 10, 36,
          56, 50, 50, 97, 97, 49, 54, 53, 45, 99, 97, 99, 49, 45, 52, 48, 48,
          56, 45, 97, 99, 52, 48, 45, 50, 56, 101, 51, 97, 52, 101, 53, 56, 48,
          99, 98, 18, 64, 18, 2, 24, 1, 26, 56, 34, 18, 116, 101, 115, 116, 45,
          99, 108, 101, 97, 114, 45, 104, 105, 115, 116, 111, 114, 121, 42, 18,
          116, 101, 115, 116, 45, 99, 108, 101, 97, 114, 45, 104, 105, 115, 116,
          111, 114, 121, 50, 7, 35, 52, 51, 54, 48, 68, 70, 58, 5, 240, 159,
          154, 175, 32, 40, 1, 50, 137, 1, 10, 36, 49, 55, 53, 48, 100, 98, 97,
          53, 45, 97, 102, 102, 101, 45, 52, 51, 50, 49, 45, 57, 53, 52, 99, 45,
          50, 55, 102, 99, 55, 48, 98, 57, 55, 98, 102, 54, 18, 97, 18, 2, 24,
          1, 26, 51, 34, 19, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104,
          97, 110, 110, 101, 108, 45, 49, 54, 42, 19, 116, 101, 115, 116, 45,
          110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 49, 54, 50, 7,
          35, 52, 51, 54, 48, 68, 70, 34, 36, 101, 48, 57, 100, 53, 53, 54, 56,
          45, 101, 49, 53, 56, 45, 52, 99, 51, 50, 45, 57, 98, 100, 102, 45, 52,
          100, 51, 54, 57, 98, 101, 97, 48, 48, 55, 57, 40, 2, 50, 101, 10, 36,
          55, 53, 100, 98, 101, 49, 54, 52, 45, 53, 57, 56, 49, 45, 52, 99, 56,
          56, 45, 98, 57, 98, 101, 45, 57, 56, 48, 98, 48, 53, 51, 54, 54, 50,
          100, 99, 18, 61, 18, 2, 24, 1, 26, 53, 34, 22, 116, 101, 115, 116, 45,
          110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 116, 111, 100,
          97, 121, 42, 18, 87, 101, 100, 32, 50, 50, 46, 32, 54, 32, 49, 57, 58,
          50, 49, 58, 53, 57, 50, 7, 35, 52, 51, 54, 48, 68, 70, 40, 12, 50,
          133, 1, 10, 36, 48, 48, 100, 51, 102, 53, 50, 53, 45, 97, 48, 99, 102,
          45, 52, 99, 52, 48, 45, 56, 51, 50, 100, 45, 53, 52, 51, 101, 99, 57,
          102, 56, 49, 56, 56, 98, 18, 93, 18, 2, 24, 1, 26, 47, 34, 18, 109,
          101, 115, 115, 97, 103, 101, 115, 45, 101, 100, 105, 116, 101, 100,
          45, 49, 52, 42, 16, 100, 115, 99, 32, 101, 100, 105, 116, 101, 100,
          32, 104, 101, 108, 108, 111, 50, 7, 35, 70, 65, 54, 53, 54, 53, 34,
          36, 101, 48, 57, 100, 53, 53, 54, 56, 45, 101, 49, 53, 56, 45, 52, 99,
          51, 50, 45, 57, 98, 100, 102, 45, 52, 100, 51, 54, 57, 98, 101, 97,
          48, 48, 55, 57, 40, 1, 50, 137, 1, 10, 36, 97, 49, 99, 102, 102, 57,
          56, 98, 45, 52, 48, 102, 100, 45, 52, 53, 53, 54, 45, 57, 53, 54, 97,
          45, 48, 56, 56, 102, 100, 99, 56, 56, 56, 98, 99, 57, 18, 97, 18, 2,
          24, 1, 26, 51, 34, 19, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99,
          104, 97, 110, 110, 101, 108, 45, 49, 55, 42, 19, 116, 101, 115, 116,
          45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 49, 55,
          50, 7, 35, 52, 51, 54, 48, 68, 70, 34, 36, 56, 102, 50, 99, 99, 53,
          100, 55, 45, 101, 99, 98, 54, 45, 52, 50, 99, 100, 45, 97, 102, 49,
          55, 45, 49, 101, 55, 101, 100, 57, 57, 51, 98, 100, 55, 97, 40, 1, 50,
          135, 1, 10, 36, 99, 56, 98, 54, 100, 102, 55, 56, 45, 57, 54, 98, 101,
          45, 52, 54, 53, 56, 45, 56, 98, 100, 101, 45, 98, 53, 49, 98, 50, 97,
          48, 57, 99, 53, 57, 57, 18, 95, 18, 2, 24, 1, 26, 49, 34, 18, 116,
          101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108,
          45, 51, 42, 18, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104,
          97, 110, 110, 101, 108, 45, 51, 50, 7, 35, 52, 51, 54, 48, 68, 70, 34,
          36, 56, 102, 50, 99, 99, 53, 100, 55, 45, 101, 99, 98, 54, 45, 52, 50,
          99, 100, 45, 97, 102, 49, 55, 45, 49, 101, 55, 101, 100, 57, 57, 51,
          98, 100, 55, 97, 40, 5, 50, 98, 10, 36, 50, 101, 56, 101, 99, 49, 57,
          98, 45, 101, 54, 52, 48, 45, 52, 98, 52, 57, 45, 57, 99, 100, 55, 45,
          54, 55, 49, 49, 98, 99, 101, 97, 99, 100, 48, 101, 18, 58, 18, 2, 24,
          1, 26, 50, 34, 21, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104,
          97, 110, 110, 101, 108, 45, 101, 100, 105, 116, 42, 16, 116, 101, 115,
          116, 45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 50, 7,
          35, 52, 51, 54, 48, 68, 70, 40, 3, 50, 135, 1, 10, 36, 100, 52, 97,
          97, 55, 101, 51, 48, 45, 56, 48, 98, 48, 45, 52, 100, 101, 101, 45,
          57, 53, 99, 57, 45, 100, 50, 53, 57, 54, 99, 56, 52, 56, 50, 52, 57,
          18, 95, 18, 2, 24, 1, 26, 51, 34, 19, 116, 101, 115, 116, 45, 110,
          101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 50, 48, 42, 19,
          116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101,
          108, 45, 50, 48, 50, 7, 35, 52, 51, 54, 48, 68, 70, 34, 36, 56, 54,
          98, 50, 57, 97, 50, 51, 45, 57, 50, 57, 97, 45, 52, 52, 99, 50, 45,
          57, 56, 102, 53, 45, 101, 51, 55, 48, 51, 97, 48, 48, 52, 100, 57, 50,
          50, 133, 1, 10, 36, 55, 57, 101, 51, 101, 48, 52, 102, 45, 97, 51, 52,
          49, 45, 52, 54, 54, 56, 45, 56, 97, 49, 51, 45, 56, 100, 53, 48, 99,
          97, 49, 57, 49, 57, 98, 97, 18, 93, 18, 2, 24, 1, 26, 49, 34, 18, 116,
          101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108,
          45, 53, 42, 18, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104,
          97, 110, 110, 101, 108, 45, 52, 50, 7, 35, 52, 51, 54, 48, 68, 70, 34,
          36, 56, 102, 50, 99, 99, 53, 100, 55, 45, 101, 99, 98, 54, 45, 52, 50,
          99, 100, 45, 97, 102, 49, 55, 45, 49, 101, 55, 101, 100, 57, 57, 51,
          98, 100, 55, 97, 50, 135, 1, 10, 36, 102, 50, 54, 53, 48, 101, 51,
          102, 45, 98, 50, 56, 53, 45, 52, 48, 52, 101, 45, 56, 97, 100, 98, 45,
          57, 99, 52, 54, 48, 55, 100, 51, 100, 49, 50, 48, 18, 95, 18, 2, 24,
          1, 26, 49, 34, 18, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104,
          97, 110, 110, 101, 108, 45, 50, 42, 18, 116, 101, 115, 116, 45, 110,
          101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 50, 50, 7, 35, 52,
          51, 54, 48, 68, 70, 34, 36, 56, 102, 50, 99, 99, 53, 100, 55, 45, 101,
          99, 98, 54, 45, 52, 50, 99, 100, 45, 97, 102, 49, 55, 45, 49, 101, 55,
          101, 100, 57, 57, 51, 98, 100, 55, 97, 40, 6, 50, 87, 10, 36, 51, 48,
          56, 48, 52, 101, 97, 55, 45, 98, 100, 54, 54, 45, 52, 100, 53, 100,
          45, 57, 49, 101, 98, 45, 98, 50, 100, 99, 102, 101, 50, 53, 49, 53,
          98, 51, 18, 47, 18, 2, 24, 1, 26, 39, 34, 13, 116, 101, 115, 116, 45,
          109, 101, 115, 115, 97, 103, 101, 115, 42, 13, 116, 101, 115, 116, 45,
          109, 101, 115, 115, 97, 103, 101, 115, 50, 7, 35, 52, 51, 54, 48, 68,
          70, 40, 7, 50, 95, 10, 36, 100, 55, 102, 55, 52, 49, 48, 49, 45, 97,
          56, 52, 99, 45, 52, 50, 51, 98, 45, 56, 50, 101, 55, 45, 97, 48, 101,
          55, 52, 51, 98, 50, 57, 48, 50, 100, 18, 55, 18, 2, 24, 1, 26, 47, 34,
          21, 116, 101, 115, 116, 45, 99, 111, 109, 109, 117, 110, 105, 116,
          121, 45, 117, 112, 100, 97, 116, 101, 42, 7, 116, 101, 115, 116, 32,
          103, 111, 50, 7, 35, 68, 65, 69, 50, 69, 55, 58, 4, 240, 159, 144,
          135, 40, 6, 50, 135, 1, 10, 36, 101, 54, 56, 55, 49, 49, 52, 49, 45,
          55, 98, 48, 53, 45, 52, 49, 51, 50, 45, 57, 57, 57, 49, 45, 102, 56,
          50, 51, 55, 53, 56, 100, 57, 55, 55, 100, 18, 95, 18, 2, 24, 1, 26,
          51, 34, 19, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97,
          110, 110, 101, 108, 45, 49, 56, 42, 19, 116, 101, 115, 116, 45, 110,
          101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 49, 56, 50, 7, 35,
          52, 51, 54, 48, 68, 70, 34, 36, 101, 48, 57, 100, 53, 53, 54, 56, 45,
          101, 49, 53, 56, 45, 52, 99, 51, 50, 45, 57, 98, 100, 102, 45, 52,
          100, 51, 54, 57, 98, 101, 97, 48, 48, 55, 57, 50, 135, 1, 10, 36, 102,
          55, 55, 99, 55, 54, 57, 49, 45, 52, 54, 50, 48, 45, 52, 48, 49, 98,
          45, 57, 100, 102, 98, 45, 55, 49, 101, 53, 102, 57, 99, 99, 48, 98,
          100, 99, 18, 95, 18, 2, 24, 1, 26, 49, 34, 18, 116, 101, 115, 116, 45,
          110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 52, 42, 18,
          116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97, 110, 110, 101,
          108, 45, 52, 50, 7, 35, 52, 51, 54, 48, 68, 70, 34, 36, 56, 102, 50,
          99, 99, 53, 100, 55, 45, 101, 99, 98, 54, 45, 52, 50, 99, 100, 45, 97,
          102, 49, 55, 45, 49, 101, 55, 101, 100, 57, 57, 51, 98, 100, 55, 97,
          40, 7, 50, 95, 10, 36, 101, 56, 101, 98, 53, 57, 97, 56, 45, 100, 56,
          57, 56, 45, 52, 100, 99, 54, 45, 56, 48, 57, 97, 45, 52, 49, 55, 49,
          100, 55, 55, 98, 50, 50, 55, 53, 18, 55, 18, 2, 24, 1, 26, 47, 34, 17,
          116, 101, 115, 116, 45, 99, 104, 97, 110, 110, 101, 108, 45, 101, 100,
          105, 116, 42, 26, 116, 101, 115, 116, 45, 99, 104, 97, 110, 110, 101,
          108, 45, 101, 100, 105, 116, 10, 10, 101, 100, 105, 116, 58, 32, 49,
          40, 5, 50, 137, 1, 10, 36, 98, 51, 49, 98, 55, 53, 55, 48, 45, 54,
          100, 99, 57, 45, 52, 53, 49, 52, 45, 98, 49, 55, 102, 45, 52, 101, 55,
          50, 52, 101, 56, 53, 53, 101, 49, 100, 18, 97, 18, 2, 24, 1, 26, 51,
          34, 19, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99, 104, 97, 110,
          110, 101, 108, 45, 49, 53, 42, 19, 116, 101, 115, 116, 45, 110, 101,
          119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 49, 53, 50, 7, 35, 52,
          51, 54, 48, 68, 70, 34, 36, 56, 102, 50, 99, 99, 53, 100, 55, 45, 101,
          99, 98, 54, 45, 52, 50, 99, 100, 45, 97, 102, 49, 55, 45, 49, 101, 55,
          101, 100, 57, 57, 51, 98, 100, 55, 97, 40, 3, 50, 145, 1, 10, 36, 97,
          56, 54, 50, 99, 48, 52, 52, 45, 52, 52, 100, 54, 45, 52, 97, 98, 57,
          45, 97, 50, 98, 52, 45, 55, 98, 101, 52, 52, 57, 49, 101, 49, 57, 52,
          48, 18, 105, 18, 2, 24, 1, 26, 59, 34, 23, 116, 101, 115, 116, 45,
          110, 101, 119, 45, 99, 104, 97, 110, 110, 101, 108, 45, 54, 45, 101,
          100, 105, 116, 42, 23, 116, 101, 115, 116, 45, 110, 101, 119, 45, 99,
          104, 97, 110, 110, 101, 108, 45, 54, 45, 101, 100, 105, 116, 50, 7,
          35, 52, 51, 54, 48, 68, 70, 34, 36, 56, 102, 50, 99, 99, 53, 100, 55,
          45, 101, 99, 98, 54, 45, 52, 50, 99, 100, 45, 97, 102, 49, 55, 45, 49,
          101, 55, 101, 100, 57, 57, 51, 98, 100, 55, 97, 40, 2, 50, 76, 10, 36,
          50, 48, 50, 101, 50, 53, 102, 50, 45, 52, 56, 97, 99, 45, 52, 101, 50,
          100, 45, 56, 102, 100, 48, 45, 97, 97, 53, 57, 55, 49, 51, 56, 51, 49,
          51, 52, 18, 36, 18, 2, 24, 1, 26, 28, 34, 4, 116, 101, 115, 116, 42,
          4, 116, 101, 115, 116, 50, 7, 35, 50, 54, 65, 54, 57, 65, 58, 5, 240,
          159, 152, 131, 32, 40, 2, 66, 93, 10, 36, 101, 48, 57, 100, 53, 53,
          54, 56, 45, 101, 49, 53, 56, 45, 52, 99, 51, 50, 45, 57, 98, 100, 102,
          45, 52, 100, 51, 54, 57, 98, 101, 97, 48, 48, 55, 57, 18, 53, 10, 36,
          101, 48, 57, 100, 53, 53, 54, 56, 45, 101, 49, 53, 56, 45, 52, 99, 51,
          50, 45, 57, 98, 100, 102, 45, 52, 100, 51, 54, 57, 98, 101, 97, 48,
          48, 55, 57, 18, 13, 116, 101, 115, 116, 45, 99, 97, 116, 101, 103,
          111, 114, 121, 66, 97, 10, 36, 56, 54, 98, 50, 57, 97, 50, 51, 45, 57,
          50, 57, 97, 45, 52, 52, 99, 50, 45, 57, 56, 102, 53, 45, 101, 51, 55,
          48, 51, 97, 48, 48, 52, 100, 57, 50, 18, 57, 10, 36, 56, 54, 98, 50,
          57, 97, 50, 51, 45, 57, 50, 57, 97, 45, 52, 52, 99, 50, 45, 57, 56,
          102, 53, 45, 101, 51, 55, 48, 51, 97, 48, 48, 52, 100, 57, 50, 18, 15,
          116, 101, 115, 116, 45, 99, 97, 116, 101, 103, 111, 114, 121, 45, 51,
          24, 1, 66, 97, 10, 36, 56, 102, 50, 99, 99, 53, 100, 55, 45, 101, 99,
          98, 54, 45, 52, 50, 99, 100, 45, 97, 102, 49, 55, 45, 49, 101, 55,
          101, 100, 57, 57, 51, 98, 100, 55, 97, 18, 57, 10, 36, 56, 102, 50,
          99, 99, 53, 100, 55, 45, 101, 99, 98, 54, 45, 52, 50, 99, 100, 45, 97,
          102, 49, 55, 45, 49, 101, 55, 101, 100, 57, 57, 51, 98, 100, 55, 97,
          18, 15, 116, 101, 115, 116, 45, 99, 97, 116, 101, 103, 111, 114, 121,
          45, 50, 24, 2, 82, 0, 24, 25,
        ]),
        signaturePublicKey: new Uint8Array([
          4, 172, 65, 157, 172, 154, 139, 187, 88, 130, 90, 60, 222, 96, 238,
          240, 238, 113, 184, 207, 108, 99, 223, 97, 30, 238, 252, 142, 122,
          172, 124, 121, 181, 89, 84, 182, 121, 210, 76, 245, 236, 130, 218,
          126, 217, 33, 202, 242, 64, 98, 138, 155, 251, 52, 80, 197, 17, 26,
          156, 255, 229, 78, 99, 24, 17,
        ]),
        timestamp: new Date(1657640185127),
      },
    ])
  })

  // page.on('websocket', ws => {
  //   console.log(`WebSocket opened: ${ws.url()}>`)
  //   ws.on('framesent', event => console.log(event.payload))
  //   ws.on('framereceived', event => console.log(event.payload))
  //   ws.on('close', () => console.log('WebSocket closed'))
  // })

  // const text = 'huh'

  // await page.addInitScript(() => {
  //   window.waku = {
  //     create: () => {
  //       // console.log('WHAT?!')
  //       console.log(text)
  //     },
  //   }
  // })

  // const window = await page.evaluate(() => {
  //   return window
  // })

  // window.waku = 'bruh'
  // waku = await page.evaluate(() => {
  //   // window.waku
  //   // return globalThis.window.waku
  //   // window.waku = {
  //   //   create: () => {
  //   //     // console.log('WHAT?!')
  //   //     console.log(text)
  //   //   },
  //   // }
  //   // return window.waku
  // })

  // console.log('HERE')
  // console.log(window)
  // // console.log(waku)
  // console.log(window.waku)

  // globalThis.window.foo = null

  // console.log(globalThis.window)

  // await page.pause()

  // Object.assign(globalThis.window.waku, mock)

  // await page.addInitScript(() => {
  //   Object.assign(window.waku, mock)
  // })

  // await page.addInitScript(() => {
  //   Object.assign(window.waku, {
  //     // todo: returns .waitForRemotePeer
  //     create: vi.fn(),
  //     libp2p: {
  //       connectionManager: {
  //         // empty so wakuDisconnectionTimer runs without effect
  //         connections: new Map(),
  //       },
  //     },
  //     stop: undefined,
  //     store: {
  //       queryHistory: undefined,
  //       addDecryptionKey: undefined,
  //     },
  //     relay: {
  //       addObserver: undefined,
  //       addDecryptionKey: undefined,
  //       deleteObserver: undefined,
  //       send: undefined,
  //     },
  //   })
  // })

  // Object.assign(window.waku, {
  //   // todo: returns .waitForRemotePeer
  //   create: vi.fn(),
  //   libp2p: {
  //     connectionManager: {
  //       // empty so wakuDisconnectionTimer runs without effect
  //       connections: new Map(),
  //     },
  //   },
  //   stop: undefined,
  //   store: {
  //     queryHistory: undefined,
  //     addDecryptionKey: undefined,
  //   },
  //   relay: {
  //     addObserver: undefined,
  //     addDecryptionKey: undefined,
  //     deleteObserver: undefined,
  //     send: undefined,
  //   },
  // })
}, 10 * 60 * 1000)

afterEach(async () => {
  await page.close()

  // todo?: use
  // vi.clearAllMocks()
})

// TODO!: fixture chat(s)
// TODO!: fixture message(s)
// TODO!: expect .close(s) to be called
test(
  'receiving message',
  async () => {
    await page.goto('http://localhost:3001')

    // Click text=t#test-messages
    await page
      .locator('text=t#test-messages')
      .click({ timeout: 15 * 60 * 1000 })
    await page.waitForURL(
      'http://localhost:3001/30804ea7-bd66-4d5d-91eb-b2dcfe2515b3'
    )

    // const foo = waku.foo
    // console.log(waku)

    await page.pause()

    // TODO!: expect a message
    // addObserver(callback: (message: WakuMessage)
    await page.evaluate(() => {
      // window.waku.foo()
      // globalThis.client.waku.foo()
      const observer = window.waku.observers
        .get('/waku/1/0x0fd9cba5/rfc26')
        // console.log('observer:', observer)
        // console.log(globalThis.client.waku.observers)
        .forEach(observer =>
          observer({
            payload: new Uint8Array([
              18, 36, 97, 101, 50, 102, 53, 98, 55, 101, 45, 54, 100, 101, 51,
              45, 53, 54, 97, 53, 45, 56, 49, 54, 101, 45, 52, 102, 97, 55, 101,
              53, 52, 48, 100, 56, 102, 53, 26, 193, 1, 10, 33, 2, 148, 197,
              104, 4, 137, 223, 84, 88, 195, 217, 246, 181, 76, 105, 34, 232,
              250, 239, 169, 40, 83, 136, 170, 1, 124, 121, 55, 181, 150, 43,
              112, 121, 18, 79, 10, 36, 97, 101, 50, 102, 53, 98, 55, 101, 45,
              54, 100, 101, 51, 45, 53, 54, 97, 53, 45, 56, 49, 54, 101, 45, 52,
              102, 97, 55, 101, 53, 52, 48, 100, 56, 102, 53, 18, 39, 10, 33, 3,
              96, 56, 253, 72, 148, 29, 245, 219, 226, 73, 68, 82, 57, 170, 5,
              185, 134, 238, 131, 170, 181, 191, 135, 29, 197, 211, 216, 67, 23,
              187, 72, 180, 16, 22, 24, 1, 34, 65, 99, 239, 168, 174, 81, 235,
              187, 54, 246, 46, 13, 100, 148, 130, 4, 48, 175, 125, 230, 33, 89,
              62, 209, 12, 190, 163, 173, 50, 34, 248, 210, 190, 0, 223, 245,
              211, 188, 21, 154, 100, 100, 139, 95, 77, 153, 84, 33, 131, 71,
              14, 254, 155, 104, 161, 36, 155, 155, 191, 89, 163, 98, 79, 177,
              1, 1, 40, 136, 249, 131, 220, 214, 203, 234, 128, 23, 178, 6, 202,
              1, 10, 65, 239, 108, 219, 51, 217, 139, 192, 153, 68, 108, 95,
              152, 154, 173, 64, 177, 8, 87, 44, 113, 205, 22, 177, 16, 133, 76,
              60, 23, 233, 132, 116, 92, 33, 202, 80, 27, 204, 111, 57, 96, 149,
              94, 41, 252, 227, 99, 42, 31, 154, 207, 46, 94, 174, 172, 239, 13,
              232, 6, 121, 229, 34, 121, 81, 167, 0, 18, 130, 1, 8, 180, 207,
              194, 225, 159, 48, 16, 180, 207, 194, 225, 159, 48, 26, 4, 72,
              101, 108, 112, 50, 104, 48, 120, 48, 50, 57, 102, 49, 57, 54, 98,
              98, 102, 101, 102, 52, 102, 97, 54, 97, 53, 101, 98, 56, 49, 100,
              100, 56, 48, 50, 49, 51, 51, 97, 54, 51, 52, 57, 56, 51, 50, 53,
              52, 52, 53, 99, 97, 49, 97, 102, 49, 100, 49, 53, 52, 98, 49, 98,
              98, 52, 53, 52, 50, 57, 53, 53, 49, 51, 51, 51, 48, 56, 48, 52,
              101, 97, 55, 45, 98, 100, 54, 54, 45, 52, 100, 53, 100, 45, 57,
              49, 101, 98, 45, 98, 50, 100, 99, 102, 101, 50, 53, 49, 53, 98,
              51, 56, 5, 64, 1, 24, 1,
            ]),
            signaturePublicKey: new Uint8Array([
              4, 148, 197, 104, 4, 137, 223, 84, 88, 195, 217, 246, 181, 76,
              105, 34, 232, 250, 239, 169, 40, 83, 136, 170, 1, 124, 121, 55,
              181, 150, 43, 112, 121, 14, 142, 76, 23, 46, 185, 35, 102, 139,
              19, 124, 48, 253, 113, 180, 105, 119, 48, 78, 217, 56, 167, 157,
              171, 98, 14, 135, 250, 32, 189, 182, 110,
            ]),
            timestamp: new Date(1657793456071),
          })
        )
    })

    // // Click text=IIdeal Aromatic Imperatorangel12:10HelpPick reactionReply to message
    // await page
    //   .locator(
    //     'text=IIdeal Aromatic Imperatorangel12:10HelpPick reactionReply to message'
    //   )
    //   .click()
    // Click text=Help
    await page.locator('text=Help').click()

    await page.pause()
  },
  30 * 60 * 1000
)

// TODO!: mock community.requestToJoin()
test.skip('sending message', async () => {
  await page.goto('http://localhost:3001')

  // Click text=Use Throwaway Profile
  await page.locator('text=Use Throwaway Profile').click()

  // TODO: Return message with the profile in members

  // Click text=t#test-messages
  await page.locator('text=t#test-messages').click()
  await page.waitForURL(
    'http://localhost:3001/30804ea7-bd66-4d5d-91eb-b2dcfe2515b3'
  )

  // Click [placeholder="Message"]
  await page.locator('[placeholder="Message"]').click()

  // Fill [placeholder="Message"]
  await page.locator('[placeholder="Message"]').fill('help')

  // Press Enter
  await page.locator('[placeholder="Message"]').press('Enter')

  // TODO!: expect "help" message
})

test.skip('replying to message', async () => {
  await page.goto('http://localhost:3001')

  // Click text=t#test-messages
  await page.locator('text=t#test-messages').click()
  await page.waitForURL(
    'http://localhost:3001/30804ea7-bd66-4d5d-91eb-b2dcfe2515b3'
  )

  // Click text=Use Throwaway Profile
  await page.locator('text=Use Throwaway Profile').click()
  // Click [aria-label="Reply to message"]
  await page.locator('[aria-label="Reply to message"]').click()
  // Click [placeholder="Message"]
  await page.locator('[placeholder="Message"]').click()
  // Fill [placeholder="Message"]
  await page.locator('[placeholder="Message"]').fill('thx')
  // Press Enter
  await page.locator('[placeholder="Message"]').press('Enter')

  // TODO!: expect reply with reference to original message
})

test.skip('reacting to message', async () => {
  await page.goto('http://localhost:3001')

  // Click text=t#test-messages
  await page.locator('text=t#test-messages').click()
  await page.waitForURL(
    'http://localhost:3001/30804ea7-bd66-4d5d-91eb-b2dcfe2515b3'
  )

  // Click text=Use Throwaway Profile
  await page.locator('text=Use Throwaway Profile').click()

  // Click text=BBumpy Absolute Crustacean12:40read docsPick reactionReply to message >> [aria-label="Pick reaction"]
  await page
    .locator(
      'text=BBumpy Absolute Crustacean12:40read docsPick reactionReply to message >> [aria-label="Pick reaction"]'
    )
    .click()

  // Click [aria-label="React with ğŸ‘ï¸"]
  await page.locator('[aria-label="React with ğŸ‘ï¸"]').click()

  // TODO!: expect a message with reaction
})
